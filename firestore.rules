rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function hasProfile() {
      return request.auth != null
        && exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function myProfile() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function myRole() {
      return hasProfile() ? myProfile().role : null;
    }

    function myAcademiaId() {
      return hasProfile() ? myProfile().academia_id : null;
    }

    function isSystemAdmin() {
      return myRole() == 'admin_sistema';
    }

    function isAcademyAdmin() {
      return myRole() == 'admin_academia';
    }

    function isProfessor() {
      return myRole() == 'professor';
    }

    function isAcademyStaff() {
      return isAcademyAdmin() || isProfessor();
    }

    function isValidEmail(email) {
      return email is string
        && email.matches('^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.(com|net|org)(\\.br)?$');
    }

    function isBlockedEmail(email) {
      return exists(/databases/$(database)/documents/emails_bloqueados/$(email));
    }

    function isSameAcademia(academiaId) {
      return academiaId is string
        && myAcademiaId() is string
        && academiaId == myAcademiaId();
    }

    function academiaExists(academiaId) {
      return academiaId is string
        && exists(/databases/$(database)/documents/academias/$(academiaId));
    }

    function treinoDocById(treinoId) {
      return get(/databases/$(database)/documents/treinos/$(treinoId)).data;
    }

    function canReadTreinoData(treinoData) {
      return request.auth != null && (
        isSystemAdmin()
        || treinoData.is_padrao == true
        || treinoData.aluno_id == request.auth.uid
        || (isProfessor() && isSameAcademia(treinoData.academia_id))
      );
    }

    match /system/{docId} {
      allow read: if docId == 'admin_lock' || request.auth != null;
      allow create: if request.auth != null
        && docId == 'admin_lock'
        && !exists(/databases/$(database)/documents/system/admin_lock)
        && request.resource.data.admin_uid == request.auth.uid;
      allow update, delete: if false;
    }

    match /academias/{academiaId} {
      allow read: if true;
      allow create, update, delete: if request.auth != null && isSystemAdmin();
    }

    match /emails_bloqueados/{emailId} {
      allow read: if request.auth != null && isSystemAdmin();
      allow create: if request.auth != null
        && isSystemAdmin()
        && request.resource.data.keys().hasAll(['email', 'blocked_at', 'blocked_by', 'reason'])
        && request.resource.data.email == emailId;
      allow update: if false;
      allow delete: if request.auth != null && isSystemAdmin();
    }

    match /users/{userId} {
      allow read: if request.auth != null && (
        request.auth.uid == userId
        || isSystemAdmin()
        || (isAcademyStaff() && isSameAcademia(resource.data.academia_id))
      );

      allow create: if request.auth != null
        && request.resource.data.keys().hasAll(['nome', 'email', 'role', 'primeiro_acesso'])
        && isValidEmail(request.resource.data.email)
        && !isBlockedEmail(request.resource.data.email)
        && (
          (
            request.auth.uid == userId
            && request.resource.data.role == 'admin_sistema'
            && (
              !exists(/databases/$(database)/documents/system/admin_lock)
              || get(/databases/$(database)/documents/system/admin_lock).data.admin_uid == userId
            )
          )
          || (
            request.auth.uid != userId
            && isSystemAdmin()
            && request.resource.data.role == 'admin_academia'
            && academiaExists(request.resource.data.academia_id)
          )
          || (
            request.auth.uid != userId
            && isAcademyStaff()
            && request.resource.data.role == 'aluno'
            && isSameAcademia(request.resource.data.academia_id)
          )
          || (
            request.auth.uid != userId
            && isAcademyAdmin()
            && request.resource.data.role == 'professor'
            && isSameAcademia(request.resource.data.academia_id)
          )
        );

      allow update: if request.auth != null
        && (
          request.auth.uid == userId
          || isSystemAdmin()
          || (isAcademyStaff() && isSameAcademia(resource.data.academia_id))
        )
        && request.resource.data.nome == resource.data.nome
        && request.resource.data.role == resource.data.role
        && (
          !request.resource.data.keys().hasAny(['academia_id'])
          || request.resource.data.academia_id == resource.data.academia_id
        )
        && (
          !request.resource.data.keys().hasAny(['email'])
          || (
            isValidEmail(request.resource.data.email)
            && !isBlockedEmail(request.resource.data.email)
          )
        );

      allow delete: if request.auth != null
        && (
          (
            isSystemAdmin()
            && resource.data.role != 'admin_sistema'
          )
          || (
            isAcademyAdmin()
            && resource.data.role == 'professor'
            && isSameAcademia(resource.data.academia_id)
          )
        );
    }

    match /treinos/{docId} {
      allow read: if canReadTreinoData(resource.data);

      allow create: if request.auth != null && (
        (
          isProfessor()
          && request.resource.data.professor_id == request.auth.uid
          && isSameAcademia(request.resource.data.academia_id)
          && request.resource.data.is_padrao != true
        )
        || (
          isSystemAdmin()
          && request.resource.data.is_padrao == true
        )
      );

      allow update: if request.auth != null && (
        (
          isSystemAdmin()
          && resource.data.is_padrao == true
        )
        || (
          isProfessor()
          && resource.data.professor_id == request.auth.uid
          && isSameAcademia(resource.data.academia_id)
          && resource.data.bloqueado_exclusao != true
        )
        || (
          isProfessor()
          && resource.data.is_padrao == true
          && request.resource.data.is_padrao == false
          && request.resource.data.origem_padrao == true
          && request.resource.data.bloqueado_exclusao == true
          && request.resource.data.professor_id == request.auth.uid
          && isSameAcademia(request.resource.data.academia_id)
        )
      );

      allow delete: if request.auth != null
        && (
          resource.data.bloqueado_exclusao != true
          || (
            resource.data.aluno_id is string
            && resource.data.aluno_id != ''
          )
        )
        && (
          (isSystemAdmin() && resource.data.is_padrao == true)
          || (
            isProfessor()
            && resource.data.professor_id == request.auth.uid
            && isSameAcademia(resource.data.academia_id)
            && resource.data.is_padrao != true
          )
        );
    }

    match /treino_itens/{docId} {
      allow read: if request.auth != null
        && resource.data.treino_id != null
        && canReadTreinoData(treinoDocById(resource.data.treino_id));
      allow create: if request.auth != null
        && isProfessor()
        && request.resource.data.treino_id != null
        && treinoDocById(request.resource.data.treino_id).professor_id == request.auth.uid
        && isSameAcademia(treinoDocById(request.resource.data.treino_id).academia_id);
      allow update, delete: if request.auth != null
        && isProfessor()
        && resource.data.treino_id != null
        && treinoDocById(resource.data.treino_id).professor_id == request.auth.uid
        && isSameAcademia(treinoDocById(resource.data.treino_id).academia_id);
    }

    match /avaliacoes/{docId} {
      allow read, write: if request.auth != null && (
        isSystemAdmin()
        || resource.data.aluno_id == request.auth.uid
        || (
          isAcademyStaff()
          && resource.data.aluno_id is string
          && isSameAcademia(get(/databases/$(database)/documents/users/$(resource.data.aluno_id)).data.academia_id)
        )
      );
    }

    match /exercicios/{docId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && isAcademyStaff();
    }

    match /sessoes_treino/{docId} {
      allow read: if request.auth != null && (
        isSystemAdmin()
        || (isAcademyStaff() && isSameAcademia(resource.data.academia_id))
        || resource.data.aluno_id == request.auth.uid
      );
      allow create: if request.auth != null
        && request.resource.data.aluno_id == request.auth.uid
        && request.resource.data.academia_id is string;
      allow update: if request.auth != null && resource.data.aluno_id == request.auth.uid;
      allow delete: if false;
    }

    match /notificacoes/{docId} {
      allow read: if request.auth != null && (
        isSystemAdmin()
        || (
          isAcademyStaff()
          && resource.data.professor_id is string
          && isSameAcademia(get(/databases/$(database)/documents/users/$(resource.data.professor_id)).data.academia_id)
        )
        || (
          resource.data.aluno_id is string
          && resource.data.aluno_id == request.auth.uid
        )
        ||
        resource.data.professor_id == request.auth.uid
      );
      allow create: if request.auth != null;
      allow update: if request.auth != null
        && (
          resource.data.professor_id == request.auth.uid
          || resource.data.aluno_id == request.auth.uid
        )
        && request.resource.data.diff(resource.data).changedKeys().hasOnly(['lida'])
        && request.resource.data.lida is bool;
      allow delete: if request.auth != null && resource.data.professor_id == request.auth.uid;
    }
  }
}
