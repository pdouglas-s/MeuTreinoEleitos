rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function: verifica se nome é "ADMIN" (maiúsculo)
    function isAdmin(nome) {
      return nome == 'ADMIN';
    }
    
    // Helper function: verifica se usuário é professor
    function isProfessor() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'professor';
    }

    // Helper function: usuário atual é o ADMIN principal
    function isAdminUser() {
      let me = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
      return me.role == 'professor' && me.nome.matches('^[Aa][Dd][Mm][Ii][Nn]$');
    }

    // Helper function: valida formato básico de e-mail
    function isValidEmail(email) {
      return email is string
        && email.matches('^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.(com|net|org)(\\.br)?$');
    }

    // Helper function: e-mail bloqueado para não ser reutilizado no sistema
    function isBlockedEmail(email) {
      return exists(/databases/$(database)/documents/emails_bloqueados/$(email));
    }
    
    // Coleção system: controle de administrador único
    match /system/{docId} {
      // admin_lock só pode ser criado uma vez, nunca deletado
      allow read: if request.auth != null;
      allow create: if request.auth != null && docId == 'admin_lock' && !exists(/databases/$(database)/documents/system/admin_lock);
      allow update, delete: if false;
    }

    // Lista de e-mails bloqueados após exclusão de perfil
    match /emails_bloqueados/{emailId} {
      allow read: if request.auth != null && isAdminUser();
      allow create: if request.auth != null
        && isAdminUser()
        && request.resource.data.keys().hasAll(['email', 'blocked_at', 'blocked_by', 'reason'])
        && request.resource.data.email == emailId;
      allow update: if false;
      allow delete: if request.auth != null && isAdminUser();
    }
    
    // users: professors can read all, alunos can read only their doc
    match /users/{userId} {
      allow read: if request.auth != null && (
        request.auth.uid == userId 
        || isProfessor()
      );
      
      // Criação de usuário: auto-registro ou professor criando aluno
      allow create: if request.auth != null 
        && request.resource.data.keys().hasAll(['nome', 'email', 'role', 'primeiro_acesso'])
        && isValidEmail(request.resource.data.email)
        && !isBlockedEmail(request.resource.data.email)
        && (
          // Auto-registro: uid autenticado = uid do documento
          (request.auth.uid == userId && (
            // ADMIN pode ser professor
            (request.resource.data.nome == 'ADMIN' && request.resource.data.role == 'professor')
            // Outros nomes só podem ser alunos
            || (request.resource.data.nome != 'ADMIN' && request.resource.data.role == 'aluno')
          ))
          // Professor criando aluno para outro usuário
          || (request.auth.uid != userId 
            && isProfessor() 
            && request.resource.data.role == 'aluno'
            && request.resource.data.nome != 'ADMIN'
          )
          // ADMIN criando professor para outro usuário
          || (request.auth.uid != userId
            && isAdminUser()
            && request.resource.data.role == 'professor'
            && request.resource.data.nome != 'ADMIN'
          )
        );
      
      allow update: if request.auth != null && (
        request.auth.uid == userId
        || isProfessor()
      ) && (
        // Não pode alterar nome
        !request.resource.data.keys().hasAny(['nome'])
        // Se alterar email, deve manter formato válido
        && (!request.resource.data.keys().hasAny(['email']) || isValidEmail(request.resource.data.email))
        && (!request.resource.data.keys().hasAny(['email']) || !isBlockedEmail(request.resource.data.email))
        // Não pode mudar role para professor (exceto se já é ADMIN)
        && (!request.resource.data.keys().hasAny(['role'])
          || request.resource.data.role == 'aluno'
          || (request.resource.data.role == 'professor' && resource.data.nome == 'ADMIN')
        )
      );
      
      // Fallback: ADMIN pode excluir perfil de professor (conta Auth pode permanecer)
      allow delete: if request.auth != null
        && isAdminUser()
        && resource.data.role == 'professor'
        && resource.data.nome != 'ADMIN';
    }

    // treinos: only owner aluno or professor can read/write
    match /treinos/{docId} {
      allow read, write: if request.auth != null && (
        isProfessor()
        || resource.data.aluno_id == request.auth.uid 
        || request.resource.data.aluno_id == request.auth.uid
      );
    }

    // treino_itens: linked to treinos - check treino ownership
    match /treino_itens/{docId} {
      allow read, write: if request.auth != null && (
        isProfessor()
        || (resource.data.treino_id != null && get(/databases/$(database)/documents/treinos/$(resource.data.treino_id)).data.aluno_id == request.auth.uid)
        || (request.resource.data.treino_id != null && get(/databases/$(database)/documents/treinos/$(request.resource.data.treino_id)).data.aluno_id == request.auth.uid)
      );
    }

    // avaliacoes: only professor or owner aluno can read/write
    match /avaliacoes/{docId} {
      allow read, write: if request.auth != null && (
        resource.data.aluno_id == request.auth.uid || isProfessor()
      );
    }

    // exercicios: banco de exercícios - professores podem criar/editar, todos podem ler
    match /exercicios/{docId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && isProfessor();
    }

    // sessoes_treino: histórico de treinos - aluno pode criar/editar suas sessões, professor pode ler todas
    match /sessoes_treino/{docId} {
      allow read: if request.auth != null && (
        isProfessor()
        || resource.data.aluno_id == request.auth.uid
      );
      allow create: if request.auth != null && request.resource.data.aluno_id == request.auth.uid;
      allow update: if request.auth != null && resource.data.aluno_id == request.auth.uid;
      allow delete: if false;
    }

    // notificacoes: professor recebe notificações dos alunos
    match /notificacoes/{docId} {
      allow read: if request.auth != null && (
        resource.data.professor_id == request.auth.uid
        || resource.data.aluno_id == request.auth.uid
      );
      allow create: if request.auth != null;
      allow update: if request.auth != null && resource.data.professor_id == request.auth.uid;
      allow delete: if request.auth != null && resource.data.professor_id == request.auth.uid;
    }
  }
}
